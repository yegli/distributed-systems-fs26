# Holiday Expense Tracker

A full-stack web application for tracking travel expenses across multiple trips. Built as a distributed-systems challenge project for FS 2026.

## What it does

Users register an account, create trips, and log expenses per trip. Each expense has an amount, currency, category, date, and optional notes. The dashboard shows all trips with totals converted to a chosen home currency (CHF, USD, or EUR). A trip detail view shows:

- **Spending breakdown chart** — doughnut chart by category, centre label with total
- **AI trip summary** — structured four-section analysis (Overview, Top Categories, Insights, Budget Tip) generated by GPT-4o-mini
- **Expense list** — table with original currency and home-currency conversion columns
- **Voice expense entry** — click mic, speak a command ("add 50 USD for dinner" or "how much did I spend on transport?"), get a spoken response

The stack demonstrates distributed systems concepts: two stateless API instances sit behind a Traefik reverse proxy that load-balances requests between them, every response carries an `X-Served-By` header identifying which instance handled it, and a PostgreSQL database is shared between both instances.

---

## Architecture

```
Browser
  └── Traefik (port 80)
        ├── /api, /health  →  api-1 (Node/Express, port 3000)  ─┐
        │                  →  api-2 (Node/Express, port 3000)  ─┤── PostgreSQL 16
        └── /              →  frontend (Nginx serving Vue SPA)   │
                                                                  └── round-robin
Traefik dashboard: http://localhost:8080
```

---

## Prerequisites

- Docker Desktop (or Docker Engine + Compose plugin)
- Node.js 22 (only needed to run `make up`, which generates the seed file locally before building images)
- `make`

---

## Getting started

### 1. Clone and enter the repository

```bash
git clone <repo-url>
cd distributed-systems-fs26
```

### 2. Create the environment file

```bash
cp .env.example .env
```

Open `.env` and fill in the required values:

| Variable | Required | Description |
|---|---|---|
| `POSTGRES_PASSWORD` | Yes | Password for the PostgreSQL `postgres` user. Any non-empty string works locally. |
| `JWT_SECRET` | Yes | Secret used to sign JWT tokens. Generate one with `openssl rand -hex 32`. |
| `OPENAI_API_KEY` | No | OpenAI key for AI summary and voice features. Leave blank for mock responses. |

Example:

```
POSTGRES_PASSWORD=supersecret
JWT_SECRET=b3f1a2c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2
OPENAI_API_KEY=sk-...
```

### 3. Start the stack

```bash
make
```

This single command:
1. Runs `npm install` in both `backend/` and `frontend/`
2. Generates `backend/src/db/seed.sql` with bcrypt-hashed demo passwords
3. Builds Docker images and starts all services (`docker compose up --build`)

Open **http://localhost** when the logs show both API instances healthy.

### Demo accounts

| Email | Password | Trips |
|---|---|---|
| `alice@example.com` | `password` | Thailand 2025, Japan 2024, Swiss Alps 2023 |
| `bob@example.com` | `password` | New York City 2025, Lisbon & Porto 2024, Iceland 2023 |

---

## Common operations

| Command | Effect |
|---|---|
| `make` / `make up` | Install deps and start the full stack |
| `make down` | Stop containers, keep the database volume |
| `make clean` | Stop containers and delete the database volume (full reset) |
| `make logs` | Tail logs for all services |
| `make ps` | Show running container status |
| `make load-test` | Run a k6 load test against the running stack (requires `make up` first) |

> **First-run note:** PostgreSQL loads schema and seed data on first start. If the dashboard looks empty, wait for the API containers to report healthy then refresh.

---

## API reference

All endpoints except `/health`, `POST /api/auth/register`, and `POST /api/auth/login` require `Authorization: Bearer <token>`. The token is obtained at login.

| Method | Path | Description |
|---|---|---|
| GET | `/health` | Health check — returns `{ status: "ok", instance: "api-1" }` |
| POST | `/api/auth/register` | Create a new account, returns JWT |
| POST | `/api/auth/login` | Verify credentials, returns JWT |
| GET | `/api/trips` | List authenticated user's trips |
| POST | `/api/trips` | Create a trip |
| GET | `/api/trips/:id` | Get a single trip with all its expenses |
| DELETE | `/api/trips/:id` | Delete a trip (cascades to expenses) |
| GET | `/api/expenses` | List all expenses; add `?trip_id=` to filter |
| POST | `/api/expenses` | Add an expense to a trip |
| DELETE | `/api/expenses/:id` | Delete a single expense |
| GET | `/api/trips/:id/summary` | Generate AI trip summary (GPT-4o-mini; mock if no API key) |
| POST | `/api/voice` | Voice command — multipart audio blob, returns transcript + response + TTS audio |

---

## Project structure

```
.
├── backend/
│   ├── Dockerfile
│   └── src/
│       ├── index.js                    Express entry point; mounts all routers
│       ├── db/
│       │   ├── schema.sql              Table definitions (auto-loaded on first DB start)
│       │   ├── generate-seed.js        Generates seed.sql with bcrypt-hashed passwords
│       │   ├── seed.sql                Generated demo data (gitignored)
│       │   └── client.js              pg.Pool singleton using DATABASE_URL
│       ├── middleware/
│       │   └── jwt.js                  Verifies Bearer token, attaches req.user
│       ├── prompts/
│       │   └── tripSummary.js          GPT prompt builder + mock summary generator
│       └── routes/
│           ├── auth.js                 POST /register, POST /login
│           ├── trips.js                CRUD for trips
│           ├── expenses.js             CRUD for expenses
│           ├── ai.js                   GET /:id/summary — aggregates + GPT call
│           └── voice.js                POST / — Whisper → intent → execute → TTS
├── frontend/
│   ├── Dockerfile                      Nginx serving Vite build output
│   ├── nginx.conf                      SPA fallback routing
│   └── src/
│       ├── main.js                     Vue app bootstrap, router, Pinia
│       ├── App.vue                     Root component
│       ├── api/
│       │   └── http.js                 Axios instance with JWT + X-Served-By interceptors
│       ├── stores/
│       │   └── auth.js                 Pinia auth store (token, email, servedBy)
│       ├── utils/
│       │   └── currency.js             Static exchange rates, convert(), fmtCurrency()
│       ├── views/
│       │   ├── LoginView.vue
│       │   ├── RegisterView.vue
│       │   ├── DashboardView.vue       Trip grid, home currency picker, create trip
│       │   └── TripView.vue            Trip detail: chart, AI summary, voice, expense list
│       └── components/
│           ├── TripCard.vue            Trip preview card with converted total
│           ├── ExpenseList.vue         Table with original + converted columns, delete
│           ├── ExpenseForm.vue         Add-expense form
│           ├── ExpenseChart.vue        Doughnut chart (Chart.js) with centre total label
│           ├── AISummary.vue           Four-section AI summary renderer with fallback
│           └── VoiceButton.vue         MediaRecorder → /api/voice → TTS playback
├── load-test/
│   ├── script.js                       k6 script (50 VUs, 30 s, JWT-authenticated)
│   └── results.md                      Load test results report
├── tasks/                              Per-feature task planning docs (01–10)
├── docker-compose.yml
├── Makefile
├── .env.example
└── DEMO.md                             Live demo walkthrough
```

---

## How the key features work

### Authentication

```
POST /api/auth/login
  → bcrypt.compare(password, hash)
  → jwt.sign({ sub: user.id, email }, JWT_SECRET, { expiresIn: '7d' })
  → { token }

Every subsequent request:
  → Authorization: Bearer <token>
  → middleware/jwt.js verifies, attaches req.user = { id, email }
```

JWT payload: `{ sub: user.id, email }`. Token expiry: 7 days.

### Currency conversion

All expense amounts are stored in their original currency. Conversion happens client-side using a static rate table (`frontend/src/utils/currency.js`) keyed to USD. The same table is mirrored in `backend/src/routes/voice.js` and `backend/src/routes/ai.js` for server-side query responses. The user's home currency choice (CHF / USD / EUR) is persisted to `localStorage`.

### Voice commands (`POST /api/voice`)

```
1. Browser records audio via MediaRecorder API (click to start, click to stop)
2. Audio blob sent as multipart/form-data with trip_id and home_currency
3. multer stores blob in memory (≤ 25 MB)
4. Whisper API (whisper-1) transcribes audio → text
5. GPT-4o-mini parses intent → { intent, amount, currency, category, date, notes, trip_hint }
6. Intent dispatcher:
   - add_expense  → INSERT INTO expenses, return new row
   - query        → aggregate SQL against active trip, convert to home currency
7. TTS API (tts-1) converts response text → MP3 → base64
8. Response: { transcript, responseText, audioBase64, newExpense }
9. Frontend plays audio, pushes newExpense into the live expense list
```

Voice queries always scope to the trip currently open in the UI. Category queries (≤ 5 results) list individual expenses; larger sets return a total + count.

### AI trip summary (`GET /api/trips/:id/summary`)

```
1. Fetch trip metadata + all expenses (amount, currency, category, date, notes)
2. Compute: tripDays, expenseCount, dailyAvgInUSD, topExpense, unusedCategories
3. Build structured prompt requesting exactly four sections:
   [OVERVIEW] · [TOP CATEGORIES] · [INSIGHTS] · [BUDGET TIP]
4. GPT-4o-mini (max_tokens: 600, temperature: 0.65) returns section-marked text
5. Frontend parseSections() splits on markers, renders each section distinctly:
   - OVERVIEW      → semi-bold banner
   - TOP CATEGORIES → coloured dots matching pie chart palette
   - INSIGHTS      → italic text
   - BUDGET TIP    → yellow highlighted box
6. If any marker is missing, falls back to plain line-split text
```

Mock responses (no API key) use the same four-section format so the UI always renders identically.

### Expense chart

Doughnut chart built with Chart.js 4 + vue-chartjs 5. Aggregates expenses by category using the same `convert()` utility (reactive to `homeCurrency` prop). An inline `beforeDraw` plugin draws the home-currency total and "total" sub-label directly on the canvas inside the doughnut hole. Only categories with spend > 0 appear in the legend.

### Load balancing

Traefik round-robins requests across `api-1` and `api-2`. Each instance sets `X-Served-By: api-1` (or `api-2`) on every response. The frontend's Axios interceptor reads this header and stores it in the Pinia auth store — the dashboard nav can display which instance handled the last request, making the load-balancing observable during demos.

---

## Database schema

```sql
users    (id, email UNIQUE, password_hash, created_at)
trips    (id, user_id → users CASCADE, name, destination, start_date, end_date, created_at)
expenses (id, trip_id → trips CASCADE, user_id → users CASCADE,
          amount NUMERIC(10,2), currency CHAR(3),
          category CHECK (food|transport|accommodation|activities|other),
          date DATE, notes TEXT, created_at)
```

---

## Environment variables

| Variable | Required | Description |
|---|---|---|
| `DATABASE_URL` | Yes (set by Compose) | PostgreSQL connection string |
| `JWT_SECRET` | Yes | HMAC secret for signing JWTs |
| `POSTGRES_PASSWORD` | Yes | PostgreSQL superuser password |
| `OPENAI_API_KEY` | No | Enables AI summary and voice features |
| `INSTANCE_NAME` | No (set by Compose) | Identifies the API instance in `X-Served-By` header |
